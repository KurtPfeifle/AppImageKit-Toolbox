language: cpp
compiler: gcc
sudo: require
dist: trusty

before_install:
  - sudo add-apt-repository -y ppa:ximion/packagekit
  - sudo apt-get -y update

install:
  - sudo apt-get -y install coreutils busybox-static appstream

before_script:

script:
    # Create an empty AppDir structure:
  - mkdir -p ./appdir/usr/{bin,share/{doc,applications,metainfo,man/man{1,7},icons/hicolor/512x512/apps}}

    # Populate the AppDir with custom AppRun, icon, .desktop file, README.md and AppStream metadata:
  - cp -a ./appimage/AppRun                              ./appdir/AppRun
  - cp -a ./appimage/README.{md,epub,html,pdf}           ./appdir/
  - cp -a ./appimage/appimagekit-toolbox.png             ./appdir/usr/share/icons/hicolor/512x512/apps/ # linuxdeployqt wants it here...
  - cp -a ./appimage/appimagekit-toolbox.png             ./appdir/                                      # appimagetool wants it here!
  - cp -a ./appimage/org.toolbox.appimagekit.desktop     ./appdir/usr/share/applications/               # linuxdeployqt wants it here...
  - cp -a ./appimage/org.toolbox.appimagekit.desktop     ./appdir/                                      # appimagetool wants it here!
  - cp -a ./appimage/org.toolbox.appimagekit.appdata.xml ./appdir/usr/share/metainfo/

    # Copy the (stub) `appimagekit-toolbox` script to its location:
  - cp -a ./appimage/appimagekit-toolbox-usage.sh        ./appdir/usr/bin/

    # Add debugging tools to toolbox:
  - cp -a /usr/bin/env                                   ./appdir/usr/bin/
  - cp -a /bin/busybox                                   ./appdir/usr/bin/

    # Add man pages to toolbox:
  - find ./usr/share/man -type f
  - find ./usr/share/doc -type f
  - cp -a ./usr/share/man/*                              ./appdir/usr/share/man/
  - cp -a ./usr/share/doc/*                              ./appdir/usr/share/doc/
    # TODO: Write and add the other AppImageKit manpages and HTML/PDF/EPUB docs too
  - cp -a /usr/share/man/man1/busybox.1*                 ./appdir/usr/share/man/man1/
  - cp -a /usr/share/man/man1/env.1*                     ./appdir/usr/share/man/man1/
  - find ./appdir/usr/share/man -type f
  - find ./appdir/usr/share/doc -type f

    # Add AppImageKit binaries (as AppImages!) to toolbox and rename them at the same time:
  - wget -c "https://github.com/AppImage/AppImageKit/releases/download/continuous/AppRun-x86_64"                                     -O ./appdir/usr/bin/AppRun
  - wget -c "https://github.com/AppImage/AppImageKit/releases/download/continuous/appimaged-x86_64.AppImage"                         -O ./appdir/usr/bin/appimaged
  - wget -c "https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage"                      -O ./appdir/usr/bin/appimagetool
  - wget -c "https://github.com/AppImage/AppImageKit/releases/download/continuous/runtime-x86_64"                                    -O ./appdir/usr/bin/runtime
  - wget -c "https://github.com/AppImage/AppImageUpdate/releases/download/continuous/AppImageUpdate-183-236e0c5-x86_64.AppImage"     -O ./appdir/usr/bin/AppImageUpdate
  - wget -c "https://github.com/AppImage/AppImageUpdate/releases/download/continuous/appimageupdatetool-183-236e0c5-x86_64.AppImage" -O ./appdir/usr/bin/appimageupdatetool
  - wget -c "https://github.com/AppImage/zsync2/releases/download/continuous/zsync2-105-7fd1caa-x86_64.AppImage"                     -O ./appdir/usr/bin/zsync2
  - wget -c "https://github.com/AppImage/zsync2/releases/download/continuous/zsyncmake2-105-7fd1caa-x86_64.AppImage"                 -O ./appdir/usr/bin/zsyncmake2
  - wget -c "https://github.com/probonopd/linuxdeployqt/releases/download/continuous/linuxdeployqt-continuous-x86_64.AppImage"       -O ./appdir/usr/bin/linuxdeployqt

    # Make AppImages executable:
  - chmod a+x ./appdir/usr/bin/*

    # Prepare for tests following later:
  - sudo mkdir -p $HOME/.local/bin
  - cd $HOME/.local/bin                                                         # change dir
  - sudo ln -s $OLDPWD/appdir/usr/bin/{AppImage,zsync,appimage,linuxdeploy}* .  # create symlinks
  - ls -l                                                                       # show symlinks
  - cd -                                                                        # change dir back

    # Check a few things (to be seen in Travis' build log):
  - ./appdir/usr/bin/AppImageUpdate     --appimage-version
  - ./appdir/usr/bin/appimaged          --appimage-version
  - ./appdir/usr/bin/appimagetool       --appimage-version
  - ./appdir/usr/bin/appimageupdatetool --appimage-version
  - ./appdir/usr/bin/linuxdeployqt      --appimage-version
  - ./appdir/usr/bin/zsync2             --appimage-version
  - ./appdir/usr/bin/zsyncmake2         --appimage-version
  - ./appdir/usr/bin/AppImageUpdate     --appimage-offset
  - ./appdir/usr/bin/appimaged          --appimage-offset
  - ./appdir/usr/bin/appimagetool       --appimage-offset
  - ./appdir/usr/bin/appimageupdatetool --appimage-offset
  - ./appdir/usr/bin/linuxdeployqt      --appimage-offset
  - ./appdir/usr/bin/zsync2             --appimage-offset
  - ./appdir/usr/bin/zsyncmake2         --appimage-offset
  - ./appdir/usr/bin/AppImageUpdate     --appimage-updateinfo
  - ./appdir/usr/bin/appimaged          --appimage-updateinfo
  - ./appdir/usr/bin/appimagetool       --appimage-updateinfo
  - ./appdir/usr/bin/appimageupdatetool --appimage-updateinfo
  - ./appdir/usr/bin/linuxdeployqt      --appimage-updateinfo
  - ./appdir/usr/bin/zsync2             --appimage-updateinfo
  - ./appdir/usr/bin/zsyncmake2         --appimage-updateinfo

    # Let `linuxdeployqt` check if libs need to be bundled with the AppDir and do it if needed:
    #- ./appdir/usr/bin/linuxdeployqt ./appdir/usr/bin/busybox                  -bundle-non-qt-libs -verbose=2  # Don't check busybox_static!
  - ./appdir/usr/bin/linuxdeployqt ./appdir/usr/bin/env                      -bundle-non-qt-libs -verbose=2

    # Let `linuxdeployqt` create the first AppImage:
    #- ./appdir/usr/bin/linuxdeployqt ./appdir/usr/share/applications/*.desktop -bundle-non-qt-libs -verbose=2 -appimage    # Creation of AppImage does not work. Why? Fails, because appimagekit-toolbox "not an ELF executable"?!?
    #- ./appdir/usr/bin/linuxdeployqt ./appdir/usr/share/applications/*.desktop -bundle-non-qt-libs -verbose=2
    #- ./appdir/usr/bin/linuxdeployqt ./appdir/usr/bin/appimagekit-toolbox-usage-sh                 -verbose=2 -appimage    # Does creation of AppImage work this way? No. Same-same...

    # Set up a VERSION string to be used for the toolbox AppImage name:
  - VERSION=$(git rev-parse --short HEAD)

    # Rename the generated AppImage with the VERSION string included:
    #- mv appimagekit-toolbox*.AppImage                                                       ./appimagekit-toolbox-made-by-ldq-continuous-git.$VERSION-x86_64.AppImage  # Renaming will not work if AppImage creation failed

    # Extract the AppImage that is in ./appdir/usr/bin/linuxdeployqt:
  - ./appdir/usr/bin/linuxdeployqt --appimage-extract

    # Check for consistency/inconsistency in appimagetool(s)
  - ls -l ./squashfs-root/usr/bin/appimagetool  ./appdir/usr/bin/appimagetool
  - md5sum ./squashfs-root/usr/bin/appimagetool ./appdir/usr/bin/appimagetool
  - ./squashfs-root/usr/bin/appimagetool --version
  - ./appdir/usr/bin/appimagetool        --version

    # Let `appimagetool` from extracted linuxdeployqt create the second AppImage:
    #- PATH=./squashfs-root/usr/bin:$PATH           ./squashfs-root/usr/bin/appimagetool -g -v ./appdir ./appimagekit-toolbox-made-by-ait-continuous-git.$VERSION-x86_64.AppImage

    # Check what we have:
  - ls -l ./appdir/AppRun ./squashfs-root/AppRun

    # Remove the symlinked AppRun and copy custom AppRun in place (dunno why line 20 didn't prevail):
  - rm -rf ./appdir/AppRun
  - cp -a ./appimage/AppRun ./appdir/

    # Let `appimagetool` downloaded into ./appdir/usr/bin  create the second AppImage:
  - PATH=./appdir/usr/bin:./squashfs-root/usr/bin:$PATH ./appdir/usr/bin/appimagetool -g -v ./appdir ./appimagekit-toolbox-made-by-ait-continuous-git.$VERSION-x86_64.AppImage
  - touch -t "201801010000.01" ./appimagekit-toolbox-made-by-ait-continuous-git.$VERSION-x86_64.AppImage

    # See what we got (just for Travis' build log):
  - find . -name "*.AppImage" -ls

    # Check a few things (to be seen in Travis' build log):
  - ./appimagekit-toolbox-made-by-ait-continuous-git.$VERSION-x86_64.AppImage --appimage-version
    #- ./appimagekit-toolbox-made-by-ldq-continuous-git.$VERSION-x86_64.AppImage --appimage-version
  - ./appimagekit-toolbox-made-by-ait-continuous-git.$VERSION-x86_64.AppImage --appimage-offset
    #- ./appimagekit-toolbox-made-by-ldq-continuous-git.$VERSION-x86_64.AppImage --appimage-offset
  - ./appimagekit-toolbox-made-by-ait-continuous-git.$VERSION-x86_64.AppImage --appimage-updateinfo
    #- ./appimagekit-toolbox-made-by-ldq-continuous-git.$VERSION-x86_64.AppImage --appimage-updateinfo

    # Create symlinks to the AppImage(s)
  - ln -s ./appimagekit-toolbox-made-by-ait-continuous-git.$VERSION-x86_64.AppImage aiktb_a
    #- ln -s ./appimagekit-toolbox-made-by-ldq-continuous-git.$VERSION-x86_64.AppImage aiktb_q

    ##############################################################
    #  Run a few sanity tests (to be seen in Travis' build log):
    ##############################################################

    # Let appimaged run in background and check later what it found
  - ./appimagekit-toolbox-made-by-ait-continuous-git.$VERSION-x86_64.AppImage   appimaged --verbose --no-install 2>appimaged.stderr &

  - ./appimagekit-toolbox-made-by-ait-continuous-git.$VERSION-x86_64.AppImage
  - ./aiktb_a
    #- ./appimagekit-toolbox-made-by-ldq-continuous-git.$VERSION-x86_64.AppImage
    #- ./aiktb_q

  - ./appimagekit-toolbox-made-by-ait-continuous-git.$VERSION-x86_64.AppImage    --help
  - ./aiktb_a                                                                    --help
    #- ./appimagekit-toolbox-made-by-ldq-continuous-git.$VERSION-x86_64.AppImage    --help
    #- ./aiktb_q                                                                    --help

  - ./appimagekit-toolbox-made-by-ait-continuous-git.$VERSION-x86_64.AppImage   --listexe
  - ./aiktb_a                                                                   --listexe
    #- ./appimagekit-toolbox-made-by-ldq-continuous-git.$VERSION-x86_64.AppImage   --listexe
    #- ./aiktb_q                                                                   --listexe

  - ./appimagekit-toolbox-made-by-ait-continuous-git.$VERSION-x86_64.AppImage   --listepub
  - ./aiktb_a                                                                   --listepub
    #- ./appimagekit-toolbox-made-by-ldq-continuous-git.$VERSION-x86_64.AppImage   --listepub
    #- ./aiktb_q                                                                   --listepub

  - ./appimagekit-toolbox-made-by-ait-continuous-git.$VERSION-x86_64.AppImage   --listhtml
  - ./aiktb_a                                                                   --listhtml
    #- ./appimagekit-toolbox-made-by-ldq-continuous-git.$VERSION-x86_64.AppImage   --listhtml
    #- ./aiktb_q                                                                   --listhtml

  - ./appimagekit-toolbox-made-by-ait-continuous-git.$VERSION-x86_64.AppImage   --listpdf
  - ./aiktb_a                                                                   --listpdf
    #- ./appimagekit-toolbox-made-by-ldq-continuous-git.$VERSION-x86_64.AppImage   --listpdf
    #- ./aiktb_q                                                                   --listpdf

  - ./appimagekit-toolbox-made-by-ait-continuous-git.$VERSION-x86_64.AppImage   --listreadme
  - ./aiktb_a                                                                   --listreadme
    #- ./appimagekit-toolbox-made-by-ldq-continuous-git.$VERSION-x86_64.AppImage   --listreadme
    #- ./aiktb_q                                                                   --listreadme

  - ./appimagekit-toolbox-made-by-ait-continuous-git.$VERSION-x86_64.AppImage   appimagetool --help
  - ./aiktb_a                                                                   appimagetool --help
  - ./appimagekit-toolbox-made-by-ait-continuous-git.$VERSION-x86_64.AppImage   appimagetool --appimage-help
  - ./aiktb_a                                                                   appimagetool --appimage-help

  - ./appimagekit-toolbox-made-by-ait-continuous-git.$VERSION-x86_64.AppImage   appimageupdatetool --help
  - ./aiktb_a                                                                   appimageupdatetool --help
  - ./appimagekit-toolbox-made-by-ait-continuous-git.$VERSION-x86_64.AppImage   appimageupdatetool --version
  - ./aiktb_a                                                                   appimageupdatetool --version
  - ./appimagekit-toolbox-made-by-ait-continuous-git.$VERSION-x86_64.AppImage   appimageupdatetool --appimage-help
  - ./aiktb_a                                                                   appimageupdatetool --appimage-help
  - ./appimagekit-toolbox-made-by-ait-continuous-git.$VERSION-x86_64.AppImage   appimageupdatetool --describe ./aiktb_a
  - ./aiktb_a                                                                   appimageupdatetool --describe ./aiktb_a
  - ./appimagekit-toolbox-made-by-ait-continuous-git.$VERSION-x86_64.AppImage   appimageupdatetool --describe $HOME/.local/bin/linuxdeployqt
  - ./aiktb_a                                                                   appimageupdatetool --describe $HOME/.local/bin/linuxdeployqt
  - ./appimagekit-toolbox-made-by-ait-continuous-git.$VERSION-x86_64.AppImage   appimageupdatetool --describe $HOME/.local/bin/appimagetool
  - ./aiktb_a                                                                   appimageupdatetool --describe $HOME/.local/bin/appimagetool
  - ./appimagekit-toolbox-made-by-ait-continuous-git.$VERSION-x86_64.AppImage   appimageupdatetool --describe $HOME/.local/bin/appimageupdatetool
  - ./aiktb_a                                                                   appimageupdatetool --describe $HOME/.local/bin/appimageupdatetool
  - ./appimagekit-toolbox-made-by-ait-continuous-git.$VERSION-x86_64.AppImage   appimageupdatetool --describe $HOME/.local/bin/AppImageUpdate
  - ./aiktb_a                                                                   appimageupdatetool --describe $HOME/.local/bin/AppImageUpdate
  - ./appimagekit-toolbox-made-by-ait-continuous-git.$VERSION-x86_64.AppImage   appimageupdatetool --describe $HOME/.local/bin/zsync2
  - ./aiktb_a                                                                   appimageupdatetool --describe $HOME/.local/bin/zsync2
  - ./appimagekit-toolbox-made-by-ait-continuous-git.$VERSION-x86_64.AppImage   appimageupdatetool --describe $HOME/.local/bin/zsyncmake2
  - ./aiktb_a                                                                   appimageupdatetool --describe $HOME/.local/bin/zsyncmake2
  - ./appimagekit-toolbox-made-by-ait-continuous-git.$VERSION-x86_64.AppImage   appimageupdatetool --describe $HOME/.local/bin/appimaged
  - ./aiktb_a                                                                   appimageupdatetool --describe $HOME/.local/bin/appimaged

  - ./appimagekit-toolbox-made-by-ait-continuous-git.$VERSION-x86_64.AppImage   appimaged --help
  - ./aiktb_a                                                                   appimaged --help
  - ./appimagekit-toolbox-made-by-ait-continuous-git.$VERSION-x86_64.AppImage   appimaged --version
  - ./aiktb_a                                                                   appimaged --version
  - ./appimagekit-toolbox-made-by-ait-continuous-git.$VERSION-x86_64.AppImage   appimaged --appimage-help
  - ./aiktb_a                                                                   appimaged --appimage-help
  
  - ./appimagekit-toolbox-made-by-ait-continuous-git.$VERSION-x86_64.AppImage   zsync2 --help
  - ./aiktb_a                                                                   zsync2 --help
  - ./appimagekit-toolbox-made-by-ait-continuous-git.$VERSION-x86_64.AppImage   zsync2 --version
  - ./aiktb_a                                                                   zsync2 --version
  - ./appimagekit-toolbox-made-by-ait-continuous-git.$VERSION-x86_64.AppImage   zsync2 --appimage-help
  - ./aiktb_a                                                                   zsync2 --appimage-help
  
  - ./appimagekit-toolbox-made-by-ait-continuous-git.$VERSION-x86_64.AppImage   zsyncmake2 --help
  - ./aiktb_a                                                                   zsyncmake2 --help
    #- ./appimagekit-toolbox-made-by-ait-continuous-git.$VERSION-x86_64.AppImage   zsyncmake2 --version   # Not supported option!
    #- ./aiktb_a                                                                   zsyncmake2 --version   # Not supported option!
  - ./appimagekit-toolbox-made-by-ait-continuous-git.$VERSION-x86_64.AppImage   zsyncmake2 --appimage-help
  - ./aiktb_a                                                                   zsyncmake2 --appimage-help

    #- ./appimagekit-toolbox-made-by-ldq-continuous-git.$VERSION-x86_64.AppImage   appimagetool --help
    #- ./appimagekit-toolbox-made-by-ldq-continuous-git.$VERSION-x86_64.AppImage   appimagetool --appimage-help
    #- ./aiktb_q                                                                   appimagetool --help
    #- ./aiktb_q                                                                   appimagetool --appimage-help

    # Check how many AppImages we have (if named with suffix .AppImage):
  - find . -name "*.AppImage" -ls

    # Debugging: find all files recursively from where we are:
  - find . -ls
  - file ./appdir/AppRun ./appimage/AppRun

#after_success:

    # Check if we have binaries which link to libraries outside of the AppImage:
  - find ./appdir -executable -type f -exec ldd {} \; | grep " => /usr" | cut -d " " -f 2-3 | sort | uniq

    # Rename the appdir
  - mv appdir appimagekit-toolbox-appdir

    # Create a tarball from renamed appdir:
  - tar cvzf ./appimagekit-toolbox-appdir.tar.gz ./appimagekit-toolbox-appdir

    # Upload AppImages to `transfer.sh`:
    # - curl --upload-file ./appimagekit-toolbox-made-by-ldq-continuous-git.$VERSION-x86_64.AppImage  https://transfer.sh/appimagekit-toolbox-made-by-ldq-continuous-git.$VERSION-x86_64.AppImage
  - curl --upload-file ./appimagekit-toolbox-made-by-ait-continuous-git.$VERSION-x86_64.AppImage  https://transfer.sh/appimagekit-toolbox-made-by-ait-continuous-git.$VERSION-x86_64.AppImage

    # Upload the renamed appdir to `transfer.sh`:
  - curl --upload-file ./appimagekit-toolbox-appdir.tar.gz                                        https://transfer.sh/appimagekit-toolbox-appdir.tar.gz

    # Get probono's upload tool/script:
  - wget -c https://github.com/probonopd/uploadtool/raw/master/upload.sh

    # Upload AppImages to GitHub's release page:
    #- bash ./upload.sh ./foo-made-by-linuxdeployqt-continuous-git.$VERSION-x86_64.AppImage
    #- bash ./upload.sh ./foo-made-by-appimagetool-continuous-git.$VERSION-x86_64.AppImage
    #- bash ./upload.sh ./Minimal-foo-AppDir.tar.gz

after_script:
  - TRAVIS_TEST_RESULT=$TRAVIS_TEST_RESULT
  - touch -t 201801010000.01 "TRAVIS_TEST_RESULT-$TRAVIS_TEST_RESULT"
  - ls -l "TRAVIS_TEST_RESULT-$TRAVIS_TEST_RESULT"
  
    # Check what appimaged discovered
  - grep -A 46 -B 3 Registering ./appimaged.stderr
  
  - for i in ./appdir/usr/bin/* ; do ./aiktb_a appimageupdatetool --describe $i 2>stderr 1>> update.descriptions 2>&1 ; echo "" >> update.descriptions ; done
  - cat update.descriptions
  - for i in ./appdir/usr/bin/* ; do echo -n "$(basename $i)  :   " ; $i --appimage-updateinfo 2>stderr 1>> update.info 2>&1 ; echo "" >> update.info ; done
  - cat update.info


before_cache:

after_failure:

after_success:

before_deploy:

deploy:

after_deploy:


branches:
  only:
    master

